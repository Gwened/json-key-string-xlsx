/*!
 * xlsx-json-js v0.1.0
 * (c) 2019-2020 diyao<raojianb@mail2.sysu.edu.cn>
 * Released under the MIT License.
 */
"use strict";function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function t(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function r(e){return function(e){if(Array.isArray(e))return a(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return a(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return a(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}var n=require("xlsx"),o=function(){function a(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a)}var o,s,i;return o=a,i=[{key:"switch2customStructure",value:function(e){for(var t=0,r=e.length;t<r;t+=1)e[t].data=a.rotateMatrix(e[t].data),e[t].data[0]=a.fillCellMerge(e[t].data[0])}},{key:"rotateMatrix",value:function(e){var t=[],r=[];e.forEach((function(e){r.push(e.length)}));for(var a=0,n=Math.max.apply(null,r);a<n;a+=1){for(var o=[],s=0,i=e.length;s<i;s+=1)o[s]=e[s][a];t.push(o)}return t}},{key:"fillCellMerge",value:function(e){for(var t=0,r=e.length;t<r;t+=1)void 0===e[t]||e[t].trim&&""===e[t].trim()?0===t?(console.warn("The first line of the json-attribute description value is forbidden to be null."),e[t]="firstLineAttrDesc"):e[t]=e[t-1]:e[t]=e[t].toString().replace(/\s/g,"");return e}},{key:"isRequire",value:function(e){return/(.*)\#require\([\'\"]*([^\'\"]+)[\'\"]*\)/gi.exec(e)}}],(s=[{key:"parse",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a="string"==typeof e?"readFile":"read",o=n[a](e,t),s=[],i=o.SheetNames;t.entry&&i.includes(t.entry)||(t.entry=i[0]);var l=t.sheets||i;l instanceof Array&&(l.unshift(t.entry),l=r(new Set(l)));var u=!0,c=!1,f=void 0;try{for(var h,v=l[Symbol.iterator]();!(u=(h=v.next()).done);u=!0){var y=h.value,p=o.Sheets[y];s.push({sheetName:y,data:n.utils.sheet_to_json(p,{header:1,raw:!0,cellDates:!0})})}}catch(e){c=!0,f=e}finally{try{u||null==v.return||v.return()}finally{if(c)throw f}}for(var d=0,m=s.length;d<m;d+=1)for(var b=s[d].data,g=0;g<b.length;g+=1)0===b[g].length&&(b.splice(g,1),g-=1);if(/\ufffd/.test(JSON.stringify(s)))throw new Error("Exceptional characters are found!");return s}},{key:"parse2json",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};console.log(this),this.zeroCorrection(),this.parsedXlsxData=this.parse(e,t),a.switch2customStructure(this.parsedXlsxData);var r=this.convertProcess(this.parsedXlsxData[0].data);return r}},{key:"zeroCorrection",value:function(){this.parse2jsonDataCache=[],this.parse2jsonCover=new Set}},{key:"analysisAttrDesc",value:function(e){var t=e.match(/\[(\d+)\]$/);return Array.isArray(t)?[!0,e.split("[")[0],+t[1]]:"[]"===e.slice(-2)?[!0,e.slice(0,-2),null]:[!1,e,null]}},{key:"createJsonEnumCol",value:function(t,r,n,o,s,i){if(""!==r){if("object"!==e(r)&&(r=r.split(".")),0===r.length)return t;var l=r.shift(),u=a.isRequire(l);if(u){l=u[1];var c=this.getParsedXlsxDataIndex(u[2]),f=this.parsedXlsxData[c].data;return f=this.convertProcess(f,c)[o],this.createJsonEnumCol(t,l,f,o,s,c)}var h=this.analysisAttrDesc(l),v=h[0],y=h[1],p=h[2],d=0===r.length;if(v){if(void 0===t[y]?t[y]=[]:Array.isArray(t[y])||(this.collectCoverKey(i,s),t[y]=[]),null===p)t[y].push(d?n||"":{});else if(d&&void 0!==t[y][p]&&this.collectCoverKey(i,s),d)t[y][p]=n||"";else{var m=t[y][p],b="object"===e(m)?m:{};t[y][p]=Object.assign({},b)}var g=p||t[y].length-1;return this.createJsonEnumCol(t[y][g],r,n,o,s,i)}return void 0===t[y]?t[y]=d?n||"":{}:"[object Object]"!==Object.prototype.toString.call(t[y])?(this.collectCoverKey(i,s),t[y]=d?n||"":{}):d&&(this.collectCoverKey(i,s),t[y]=n||""),this.createJsonEnumCol(t[y],r,n,o,s,i)}}},{key:"convertProcess",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=[];if(this.parse2jsonDataCache[t])return this.parse2jsonDataCache[t];for(var a=e[0].concat(),n=1,o=e.length;n<o;n+=1){for(var s=e[n],i={},l=0,u=s.length;l<u;l+=1)this.createJsonEnumCol(i,a[l],s[l],n-1,l,t);r.push(i)}return this.parse2jsonDataCache[t]=r,r}},{key:"getParsedXlsxDataIndex",value:function(e){var t;if("number"==typeof+e&&+e<this.parsedXlsxData.length)return+e;for(var r=0,a=this.parsedXlsxData.length;r<a;r+=1)if(e===this.parsedXlsxData[r].sheetName){t=r;break}if(void 0===t)throw new Error("'required' parameter is not valid: There is no such 'sheet': ".concat(e));return t}},{key:"collectCoverKey",value:function(e,t){var r=this.parsedXlsxData[e].sheetName,a=this.parsedXlsxData[e].data[0][t],n='sheet name "'.concat(r,'", row ').concat(t+1,', value "').concat(a,'"');this.parse2jsonCover.add(n)}}])&&t(o.prototype,s),i&&t(o,i),a}(),s=new o;Object.defineProperties(o,{parse:{value:s.parse.bind(s)},parse2json:{value:s.parse2json.bind(s)},parse2jsonDaTa:{value:s.parse2jsonDaTa},parse2jsonCover:{value:s.parse2jsonCover},parsedXlsxData:{value:s.parsedXlsxData}}),module.exports=o;