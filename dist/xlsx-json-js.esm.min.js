/*!
 * xlsx-json-js v0.1.0
 * (c) 2019-2020 diyao<raojianb@mail2.sysu.edu.cn>
 * Released under the MIT License.
 */
import e from"xlsx";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function a(e){return function(e){if(Array.isArray(e))return n(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return n(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return n(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}var o=function(){function n(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n)}var o,s,i;return o=n,i=[{key:"switch2customStructure",value:function(e){for(var t=0,r=e.length;t<r;t+=1)e[t].data=n.rotateMatrix(e[t].data),e[t].data[0]=n.fillCellMerge(e[t].data[0])}},{key:"rotateMatrix",value:function(e){var t=[],r=[];e.forEach((function(e){r.push(e.length)}));for(var a=0,n=Math.max.apply(null,r);a<n;a+=1){for(var o=[],s=0,i=e.length;s<i;s+=1)o[s]=e[s][a];t.push(o)}return t}},{key:"fillCellMerge",value:function(e){for(var t=0,r=e.length;t<r;t+=1)void 0===e[t]||e[t].trim&&""===e[t].trim()?0===t?(console.warn("The first line of the json-attribute description value is forbidden to be null."),e[t]="firstLineAttrDesc"):e[t]=e[t-1]:e[t]=e[t].toString().replace(/\s/g,"");return e}},{key:"isRequire",value:function(e){return/(.*)\#require\([\'\"]*([^\'\"]+)[\'\"]*\)/gi.exec(e)}}],(s=[{key:"parse",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="string"==typeof t?"readFile":"read",o=e[n](t,r),s=[],i=o.SheetNames;r.entry&&i.includes(r.entry)||(r.entry=i[0]);var l=r.sheets||i;l instanceof Array&&(l.unshift(r.entry),l=a(new Set(l)));var u=!0,c=!1,f=void 0;try{for(var h,v=l[Symbol.iterator]();!(u=(h=v.next()).done);u=!0){var p=h.value,y=o.Sheets[p];s.push({sheetName:p,data:e.utils.sheet_to_json(y,{header:1,raw:!0,cellDates:!0})})}}catch(e){c=!0,f=e}finally{try{u||null==v.return||v.return()}finally{if(c)throw f}}for(var d=0,m=s.length;d<m;d+=1)for(var b=s[d].data,g=0;g<b.length;g+=1)0===b[g].length&&(b.splice(g,1),g-=1);if(/\ufffd/.test(JSON.stringify(s)))throw new Error("Exceptional characters are found!");return s}},{key:"parse2json",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};console.log(this),this.zeroCorrection(),this.parsedXlsxData=this.parse(e,t),n.switch2customStructure(this.parsedXlsxData);var r=this.convertProcess(this.parsedXlsxData[0].data);return r}},{key:"zeroCorrection",value:function(){this.parse2jsonDataCache=[],this.parse2jsonCover=new Set}},{key:"analysisAttrDesc",value:function(e){var t=e.match(/\[(\d+)\]$/);return Array.isArray(t)?[!0,e.split("[")[0],+t[1]]:"[]"===e.slice(-2)?[!0,e.slice(0,-2),null]:[!1,e,null]}},{key:"createJsonEnumCol",value:function(e,r,a,o,s,i){if(""!==r){if("object"!==t(r)&&(r=r.split(".")),0===r.length)return e;var l=r.shift(),u=n.isRequire(l);if(u){l=u[1];var c=this.getParsedXlsxDataIndex(u[2]),f=this.parsedXlsxData[c].data;return f=this.convertProcess(f,c)[o],this.createJsonEnumCol(e,l,f,o,s,c)}var h=this.analysisAttrDesc(l),v=h[0],p=h[1],y=h[2],d=0===r.length;if(v){if(void 0===e[p]?e[p]=[]:Array.isArray(e[p])||(this.collectCoverKey(i,s),e[p]=[]),null===y)e[p].push(d?a||"":{});else if(d&&void 0!==e[p][y]&&this.collectCoverKey(i,s),d)e[p][y]=a||"";else{var m=e[p][y],b="object"===t(m)?m:{};e[p][y]=Object.assign({},b)}var g=y||e[p].length-1;return this.createJsonEnumCol(e[p][g],r,a,o,s,i)}return void 0===e[p]?e[p]=d?a||"":{}:"[object Object]"!==Object.prototype.toString.call(e[p])?(this.collectCoverKey(i,s),e[p]=d?a||"":{}):d&&(this.collectCoverKey(i,s),e[p]=a||""),this.createJsonEnumCol(e[p],r,a,o,s,i)}}},{key:"convertProcess",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=[];if(this.parse2jsonDataCache[t])return this.parse2jsonDataCache[t];for(var a=e[0].concat(),n=1,o=e.length;n<o;n+=1){for(var s=e[n],i={},l=0,u=s.length;l<u;l+=1)this.createJsonEnumCol(i,a[l],s[l],n-1,l,t);r.push(i)}return this.parse2jsonDataCache[t]=r,r}},{key:"getParsedXlsxDataIndex",value:function(e){var t;if("number"==typeof+e&&+e<this.parsedXlsxData.length)return+e;for(var r=0,a=this.parsedXlsxData.length;r<a;r+=1)if(e===this.parsedXlsxData[r].sheetName){t=r;break}if(void 0===t)throw new Error("'required' parameter is not valid: There is no such 'sheet': ".concat(e));return t}},{key:"collectCoverKey",value:function(e,t){var r=this.parsedXlsxData[e].sheetName,a=this.parsedXlsxData[e].data[0][t],n='sheet name "'.concat(r,'", row ').concat(t+1,', value "').concat(a,'"');this.parse2jsonCover.add(n)}}])&&r(o.prototype,s),i&&r(o,i),n}(),s=new o;Object.defineProperties(o,{parse:{value:s.parse.bind(s)},parse2json:{value:s.parse2json.bind(s)},parse2jsonDaTa:{value:s.parse2jsonDaTa},parse2jsonCover:{value:s.parse2jsonCover},parsedXlsxData:{value:s.parsedXlsxData}});var i=o;export default i;